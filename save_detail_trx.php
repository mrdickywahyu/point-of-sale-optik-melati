<?php// include headerinclude "header.php";$productBarcode = $_POST['productBarcode'];$createdDate = date('Y-m-d H:i:s');$userID = $_SESSION['userID'];$yes = $_POST['yes'];$invoice = $_POST['invoice'];if ($yes == 'yes'){	$fakturget = $invoice;}else{	$fakturget = $faktur;}$queryProduct = "SELECT productStock, productDiscount, productSalePrice, productBuyPrice FROM as_products WHERE productBarcode = '$productBarcode'";$sqlProduct = mysqli_query($connect, $queryProduct);$numProduct = mysqli_num_rows($sqlProduct);$dataProduct = mysqli_fetch_array($sqlProduct);if ($numProduct == '0'){	echo json_encode(array("NO", NULL, NULL));}else{	if ($dataProduct['productStock'] == '0')	{		echo json_encode(array("ERROR", NULL, NULL));	}		else 	{		$subtotal = 1 * $dataProduct['productSalePrice'];		$discTotal = ($dataProduct['productDiscount']/100) * $subtotal;		$subDisc = $subtotal - $discTotal;		$subtotalModal = 1 * $dataProduct['productBuyPrice'];		$discPercent = $dataProduct['productDiscount'];				$filterQuery = "SELECT * FROM as_sales_detail_transactions WHERE invoiceID = '$fakturget' AND productBarcode = '$productBarcode'";		$filterSql = mysqli_query($connect, $filterQuery);		$filterNum = mysqli_num_rows($filterSql);				if ($filterNum > 0)		{			echo json_encode(array("EXIST", NULL, NULL));		}		else		{			$queryTrx = "INSERT INTO as_sales_detail_transactions(	invoiceID,																	productBarcode,																	detailModal,																	detailSubtotalModal,																	detailPrice,																	detailQty,																	discPercent,																	discTotal,																	detailSubtotal,																	createdDate,																	createdUserID,																	modifiedDate,																	modifiedUserID)															VALUES(	'$fakturget',																	'$productBarcode',																	'$dataProduct[productBuyPrice]',																	'$subtotalModal',																	'$dataProduct[productSalePrice]',																	'1',																	'$discPercent',																	'$discTotal',																	'$subDisc',																	'$createdDate',																	'$userID',																	'',																	'')";			mysqli_query($connect, $queryTrx);			$queryShow = "SELECT A.detailID, A.discPercent, A.discTotal, A.detailModal, A.detailSubtotalModal, A.invoiceID, A.detailPrice, A.detailQty, A.detailSubtotal, B.productBarcode, B.productName						FROM as_sales_detail_transactions A INNER JOIN as_products B ON A.productBarcode=B.productBarcode 						WHERE A.invoiceID = '$fakturget'";			$sqlShow = mysqli_query($connect, $queryShow);			$dataShow = array();			// fetch data			$i = 1;			while ($dtShow = mysqli_fetch_array($sqlShow))			{				$dataShow[] = array(	'detailID' => $dtShow['detailID'],										'productBarcode' => $dtShow['productBarcode'],										'productName' => $dtShow['productName'],										'detailPrice' => rupiah($dtShow['detailPrice']),										'detailQty' => $dtShow['detailQty'],										'detailSubtotal' => rupiah($dtShow['detailSubtotal']),										'discPercent' => $dtShow['discPercent'],										'discTotal' => $dtShow['discTotal'],										'no' => $i);																$total = $total + $dtShow['detailSubtotal'];				$modal = $modal + $dtShow['detailSubtotalModal'];				$discTotal2 = $discTotal2 + $dtShow['discTotal'];				$i++;			}			$rupiah = rupiah($total);			$discTotalRupiah = rupiah($discTotal2);						$ppn = ($dataIdentity['identityPPN']/100 * $total);			$ppnrupiah = rupiah($ppn);						$grandtotal = $total + $ppn;			$grandtotalrupiah = rupiah($grandtotal);					echo json_encode(array($dataShow, $total, $rupiah, $modal, $ppn, $ppnrupiah, $grandtotal, $grandtotalrupiah, $discTotal2, $discTotalRupiah));		}
	}}exit();?>